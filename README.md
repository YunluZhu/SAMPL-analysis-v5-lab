# Vertical Fish Analysis

The VF analysis package reads LabView .dlm files generated by free swimming vertical fish apparatus (preprocessing), extracts and analyzes bouts (bout_analysis), and make figures (visualization).

For the current version (v2_0), users need to run `vf_analysis_by_folder.py` or `vf_analysis_test.py` to analyze .dlm files. The `_cli.py` takes command line inputs and can be ran from terminal. Then, run individual visualization scripts under `vf_analysis/vf_visualization/` to make figures. Interactive console is recommended for running visualizations. See below for detailed instructions.

**UPDATES v2_0**

1. In the function `analyze_dlm_resliced`, each epoch with more than 1 fish (which were disgarded in previous versions) are resliced at the frames with >1 fish, generating new epochNum. This mechods increases bout yield from the same data by ~60%
2. For all the visualizations, now takes the first 3 characters, instead of 1, as the first ccondition (dpf, or dpf+LD condition, or others)
3. Added code for TSNE & clustering visualization

## Prerequisites and tips

1. Conda environment is recommended. Download miniconda here: <https://docs.conda.io/en/latest/miniconda.html>
2. To get required packages, try loading the `docs/yzvf.yml` YAML file. If this failes, create a new environment and install packages in the `docs/pkgs.txt`.
3. Setting up conda envs can be the most time-consuming step. Be patient and google a lot.
4. Visual Studio Code is a good IDE and is compatible with Jupyter Notebook
5. VS code Python Extension supports Interactive Window
    - You can create cells on a Python file by typing `# %%`
	- Use `Shift`+`Enter` to run a cell, the output will be shown in the interactive window

## Analyze .dlm files

1. Organize .dlm files. Each folder with .dlm files will be recognized as one "experiment (exp)" during jackknife analysis. Therefore, if you want to combine all data from a certain clutch, put them into the same folder. Required folder structure:

```bash
├── root
    ├── 7dd_ctrl
    │   ├── 200607 ***
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   ├── 200611 ***
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    ├── 7dd_condition
    │   ├── 200607 ***
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   ├── 200611 ***
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    └── 4dd_ctrl
        └── 20**** ***
            └── ****.dlm
```

**Notes**

- 7dd_ctrl: one digit/character (dpf) + two letters (light-dark condition) + _ + flexible (condition)
- 200607 xxx: start with 6 digits (exp date) + flexible

2. Get the root directory of .dlm files and run vf_analysis_by_folder_cli.py. It will go through all subfolders, find .dlm files, call the 2 functions in preprocessing, save analyzed results in .dlm folders.
    - alternatively, you may run the "vf_analysis_test.py" which only analyzes .dlm files under the given directory.
    - for both scripts, .dlm files with the same path (under the same folder) will be analyzed together. Results from all the .dlm files will be concatenated.

## Make plots

1. Run individual script under `/vf_visualization/`.
    - for the current version, each visualization script takes a root directory including all analyzed data, which should be same as the one fed to the `vf_analysis_by_folder.py`
    - all visualization scripts get metadata (experimental conditions and age info) from folder names
    - in IEIpitch and parabola scripts, data from fish with same age are plotted together in each plot under the same column. If you have multiple dpfs, you'll get multiple columns of plots. Feel free to change this if you want to compare fish at different ages under the same condition.
    - jackknife, instead of bootstrap, is used for statistical analyses
    - refer to the beginning of each visualization script for its function
    - for bout-probability parabola fit, run the full parabola script first. Figure out the mean x-intersect. Then use it for half-parabola fit
    - `atk_angle_fin_body_ratio.py` requires lots of edits to adapt to your own data set.

2. Alternatively, you can run the `vf_visualization_pipeline.py` which calls functions from the `vf_analysis/vf_visualization/` folder.
    - all of these functions are exactly the same as the ones in `/vf_visualization/`
    - if you want to personalize the pipeline script, remember to change the according script under the `vf_analysis/vf_visualization/` folder

## Other Instructions

1. Jupyter Notebooks
    - two jupyter notebooks are included. Although they are earlier versions, not much has been changed in the Python script.
    - these notebooks are well annotated with step-by-step instructions and additional code. They may (or may not) be easier to digest.
    - `Analyze_VF` includes all preprocessing code
    - `Grab_Bouts` covers `grab_fish_angle.py` code
    - You may also copy and paste preprocessing/grab_fish_angle scrip code into any jupyter notebook. Formats are compatible.

2. The grab fish angle code
    - it was originally written by DEE. This code extracts lots of data but most of which are not used in visualization.
    - the Python version saves variables into dataframe-like structures instead of individual lists
    - analyzed results (dataframes) are saved in "sheets" of hdf5 files. The .h5 file names should be self-explanatory. Refer to the catalog excel file for specific parameter names.

3. Future changes
    - more visualization code will be added.
