# Vertical Fish Analysis

This code is for analysis and visualization of data generated using free-swimming apparatus. 

The VF analysis package reads LabView .dlm files generated by free swimming vertical fish apparatus (preprocessing), extracts and analyzes bouts (bout_analysis), and makes figures (visualization).

Run `vf_analysis/vf_analysis_....py` to analyze .dlm files. Then, run individual visualization scripts under `vf_visualization/` to make figures. See below for detailed instructions.

**Warning:** This is my working code which means you will have to make modifications for the code to work for your dataset. If you want a version that works out of the box, check the package under `docs/VF_analysis_paper`

## Version notes

**UPDATE log** (v4.1.220610)

1. Shortened aligned bout duration
2. Added arrangement scripts
3. Visualization code streamlined. Added functions to get features and kinetics
4. New Fin-Body algorithm
5. Visualization code now takes zeitgeber time (ztime) as a second input (other than `root`). Legal inputs are: `'day'`, `'night'`, and `'all'`.

**To dos** (220610)

- a table describing parameters
- streamline IBI timing scripts

## Prerequisites and tips

Build with Python3.8. See `environment.yml` for required packages.

1. Conda environment is recommended. Download miniconda here: <https://docs.conda.io/en/latest/miniconda.html>
2. To get required packages, try loading the `docs/environment.yml` YML file.
3. Setting up conda envs can be the most time-consuming step. Be patient and prepare to Google a lot.
4. Visual Studio Code is a good IDE and is compatible with Jupyter Notebook
5. VS code Python Extension supports Interactive Window
    - You can create cells on a Python file by typing `# %%`
    - Use `Shift`+`Enter` to run a cell, the output will be shown in an interactive window

## Usage

### Contents

`docs` contains a copy of catalog files generated after running `.../vf_analysis/vf_analysis_by_folder_v4.py`, the conda env file, and expected number of swim bouts captured over 24 hrs per box in constant dark.

`docs/VF_analysis_paper` contains code for the behavior mechod manuscript that should work out of the box.

`vf_analysis` folder contains all the scripts for data analysis.

`vf_visualization` includes all scripts for plotting.

`vf_dataARR` contains code for raw data arrangement. These scripts read metadata files (.ini) and arrange raw data collected from multiple boxes into organized structure (see Data arrangement section below). Arrangement scripts are specific to the experiments so you may want to write your own code that works for your experimental conditions.

### Data arrangement

1. Organize .dlm files. Each folder with .dlm files will be recognized as one "experiment (exp)" during jackknife analysis. Therefore, if you want to combine all data from a certain clutch, put them into the same folder. See below for a sample structure. For the folders representing experimental conditions, 2 conditions separated by "_" are taken as inputs. e.g. `cond1_cond2`. For consistency, it is recommended to use `cond1` for the age of the fish and/or light-dark condition and mark the experimental condition using `cond2`.
2. However, for the analysis code to work, your data doesn't have to be in this structure. `vf_analysis/vf_analysis....py` looks for all .dlm under the directory and subfolders in the directory the user specifies. Therefore, it can be used to analyze data generated from a single experiment by giving it (in the example below) `root/7dd_ctrl/200607 ***` as the root directory. Again, all .dlm files under the same folder will be combined for analysis, if you want to treat them as different "conditions", move them into different parent folders and name the parent folders as described above.
3. It is recommended to wirte an arrangement code that reads metadata files (.ini) and organizes your .dlm data instead of moving files manually. See `vf_dataARR` for some sample scripts.

```bash
├── root
    ├── 7dd_ctrl
    │   ├── 200607 ***
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   ├── 200611 ***
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    ├── 7dd_condition
    │   ├── 200607 ***
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   ├── 200611 ***
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    └── 4dd_ctrl
        └── 20**** ***
            └── ****.dlm
```

### Analyze raw data files

To analyze data generated using the free-swimming apparatus:

1. Run `vf_analysis/vf_analysis_....py`.
2. Follow the instruction and input the root path that contains data files (.dlm) and corresponding metadata files (.ini). Data can be directly under the root directory or under subfolders within the root directory. See notes for details.
3. Follow the instruction and input the frame rate (in integer). See notes for details.
4. The program will go through every data file in each subfolder (if there is any) and extract swim attributes.

When done, there will be three hdf5 files (.h5) under each directory that contains data file(s) together with catalog files that explains the parameters extracted. A copy of catalog files can be found under `docs`.

All the extracted swim bouts under `bout_data.h5` are aligned at the time of the peak speed. Each aligned bout contains swim parameters from 500 ms before to 300 ms after the time of the peak speed.

**Notes** on data analysis

- All the .dlm data files under the same directory will be combined for bout extraction. To analyze data separately, please move data files (.dlm) and corresponding metadata files (.ini) into subfolders under the root path.
- Analysis program will stop if it fails to detect any swim bout in a data file (.dlm). To avoid this, please make sure all data files to be analyzed are reasonably large so that it contains at least one swim bout. Generally, we found > 10 MB being a good criteria.
- Please input the correct frame rate as this affects calculation of parameters. This program only accepts one frame rate number for each run. Therefore, all data files under the root path need to be acquired under the same frame rate.

### Make figures

1. **IMPORTANT** update `vf_visualization/plot_functions/get_data_dir.py` to specify the names of your datasets and the directory of it. `get_data_dir(pick_data)` is called by every *visualization script*. Therefore, instead of typing directories for different datasets to plot everytime, specifying the name of your dataset in *visualization scripts* `pick_data = '<NAME OF YOUR DATASET>'` tells the script which data to plot. Also update the `get_figure_dir()` function in `get_data_dir.py`. This should be the root folder to save all plotted figures. Subfolders named by the name of your datadsets (input to `pick_data`) will be created under your `get_figure_dir(pick_data)` directory.
2. Run individual scripts under `vf_visualization/`.
    - each visualization script takes a root directory including all analyzed data, which should be same as the one fed to the analysis code. Visualization scripts calls `get_data_dir.py` to look for data direcotires.
    - all visualization scripts get experimental conditions and age info from folder names
    - jackknife is used for resampling in some scripts

**Visualization scripts and function** explained

- `Bfeatures_1_timed_bySpdUD.py` plots bout features as a function of time (time series). Bouts are segmented by peak swim speed & separated by pitch up vs down.
- `Bfeatures_2_old.py` is a legacy script that plots individual bout features.
- `Bfeatures_3_distribution.py` looks at distribution of features. Also allows you to plot one feature against another in 2D histogram.
- `Bfeatures_4_byPitch.py` calculates binned average features by pitch and plots the mean as a function of pitch. `Bfeatures_3_distribution` is a better way to plot in most of the time.
- `Bfeatures_4_by....py`. Similarly, all other plot-by-feature scripts plot binned average of one feature against another.
- `IBI_pitch_mean.py` plots pitch distribution and its std() during inter bout interval (IBI).
- `IBI_timing_full.py` plots bout frequency (reverse of IBI duration) as a function of pitch and fits it with a parabola.
- `B_kinetics.py` plots bout kinetics.
- `B_fin_body_coor.py` plots fin-body coordination.
