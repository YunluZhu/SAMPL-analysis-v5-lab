# Vertical Fish Analysis

Code related to Zhu Y, Auer F, Ehrlich DE, Schoppik D., 2022.

This code is for analysis and visualization of data generated using free-swimming apparatus.

The VF analysis package reads LabView .dlm files generated by free swimming vertical fish apparatus (preprocessing), extracts and analyzes bouts (bout_analysis), and make figures (visualization).

For the current version (v4.1), users need to run `vf_analysis_by_folder_v4.py` to analyze .dlm files. Then, run individual visualization script under `vf_analysis/vf_visualization/` to make figures. See below for detailed instructions.

**UPDATES v4.1**
xxxxx

## Prerequisites and tips

Build with Python3.8. See `environment.yml` for required packages.

1. Conda environment is recommended. Download miniconda here: <https://docs.conda.io/en/latest/miniconda.html>
2. To get required packages, try loading the `docs/yzvf.yml` YAML file. If this failes, create a new environment and install packages in the `docs/pkgs.txt`. (to be updated)
3. Setting up conda envs can be the most time-consuming step. Be patient and google a lot.
4. Visual Studio Code is a good IDE and is compatible with Jupyter Notebook
5. VS code Python Extension supports Interactive Window
    - You can create cells on a Python file by typing `# %%`
	- Use `Shift`+`Enter` to run a cell, the output will be shown in the interactive window

## Usage

### Contents

### Data arrangement

1. Organize .dlm files. Each folder with .dlm files will be recognized as one "experiment (exp)" during jackknife analysis. Therefore, if you want to combine all data from a certain clutch, put them into the same folder. See below for a sample structure. For the folders representing experimental conditions, 2 conditions separated by "_" are taken as inputs. e.g. `cond1_cond2`. For consistency, it is recommended to use `cond1` for the age of the fish and/or light-dark condition and mark the experimental condition using `cond2`.

```bash
├── root
    ├── 7dd_ctrl
    │   ├── 200607 ***
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   ├── 200611 ***
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    ├── 7dd_condition
    │   ├── 200607 ***
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   ├── 200611 ***
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    │   │   ├── ****.dlm
    └── 4dd_ctrl
        └── 20**** ***
            └── ****.dlm
```

### Analyze raw data files

To analyze data generated using the free-swimming apparatus:

1. Run `vf_analysis.py` under `.../src/vf_analysis/`.
2. Follow the instruction and input the root path that contains data files (.dlm) and corresponding metadata files (.ini). Data can be directly under the root directory or under subfolders within the root directoty. See notes for details.
3. Follow the instruction and input the frame rate (in integer). See notes for details.
4. The program will go through every data file in each subfolder (if there is any) and extract swim attributes.

When done, there will be three hdf5 files (.h5) under each directory that contains data file(s) together with catalog files that explains the parameters extracted. A copy of catalog files can be found under `docs`.

All the extracted swim bouts under `bout_data.h5` are aligned at the time of the peak speed. Each aligned bout contains swim parameters from 500 ms before to 300 ms after the time of the peak speed.

**Notes** on data analysis

- All the .dlm data files under the same directory will be combined for bout extraction. To analyze data separately, please move data files (.dlm) and corresponding metadata files (.ini) into subfolders under the root path.
- Analysis program will stop if it fails to detect any swim bout in a data file (.dlm). To avoid this, please make sure all data files to be analyzed are reasonably large so that it contains at least one swim bout. Generally, we found > 10 MB being a good criteria.
- Please input the correct frame rate as this affects calculation of parameters. This program only accepts one frame rate number for each run. Therefore, all data files under the root path need to be acquired under the same frame rate.

### Make figures

1. Run individual script under `/vf_visualization/`.
    - for the current version, each visualization script takes a root directory including all analyzed data, which should be same as the one fed to the `vf_analysis_by_folder.py`
    - all visualization scripts get metadata (experimental conditions and age info) from folder names
    - jackknife is used for statistical analyses in some scripts
    - refer to the beginning of each visualization script for its function

**Visualization scripts and function** explained

-
